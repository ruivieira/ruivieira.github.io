<!doctype html><html lang=en-uk><head><script data-goatcounter=https://ruivieira-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js></script>
<script src=https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js></script>
<script type=module src=/js/deeplinks/deeplinks.js></script>
<link rel=preload href=/lib/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/firacode/FiraCode-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/prociono/Prociono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=stylesheet href=/css/kbd.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>A simple Python benchmark exercise Â· Rui Vieira</title><link rel=canonical href=/a-simple-python-benchmark-exercise.html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="A simple Python benchmark exercise"><meta property="og:description" content="Recently when discussing the Crystal language and specifically the Gibbs sample blog post with a colleague, he mentioned that the Python benchmark numbers looked a bit off and not consistent with his experience of numerical programming in Python.
To recall, the numbers were:
Language Time(s) R 364.8 Python 144.0 Scala 9.896 Crystal 5.171 C 5.038 To have a better understanding of what is happening, I&rsquo;ve decided to profile and benchmark that code (running on Python 3."><meta property="og:type" content="article"><meta property="og:url" content="/a-simple-python-benchmark-exercise.html"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2023-01-15T15:53:40+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A simple Python benchmark exercise"><meta name=twitter:description content="Recently when discussing the Crystal language and specifically the Gibbs sample blog post with a colleague, he mentioned that the Python benchmark numbers looked a bit off and not consistent with his experience of numerical programming in Python.
To recall, the numbers were:
Language Time(s) R 364.8 Python 144.0 Scala 9.896 Crystal 5.171 C 5.038 To have a better understanding of what is happening, I&rsquo;ve decided to profile and benchmark that code (running on Python 3."><link rel=stylesheet href=/css/styles.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=images/favicon.ico></head><body class="max-width mx-auto px3 ltr" x-data="{currentHeading: undefined}"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></span><br><div id=share style=display:none></div><div id=toc><h4>Contents</h4><nav id=TableOfContents><ul></ul></nav></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">A simple Python benchmark exercise</h1><div class=meta><div class=postdate>Updated <time datetime="2023-01-15 15:53:40 +0000 GMT" itemprop=datePublished>2023-01-15</time>
<span class=commit-hash>(<a href=/log/index.html#fe73f60>fe73f60</a>)</span></div></div></header><div class=content itemprop=articleBody><p>Recently when discussing the Crystal language and specifically the <a href=/a-gibbs-sampler-in-crystal.html>Gibbs sample blog post</a> with a colleague, he mentioned that the Python benchmark numbers looked a bit off and not consistent with his experience of numerical programming in Python.</p><p>To recall, the numbers were:</p><table><thead><tr><th>Language</th><th style=text-align:left>Time(s)</th></tr></thead><tbody><tr><td>R</td><td style=text-align:left>364.8</td></tr><tr><td>Python</td><td style=text-align:left>144.0</td></tr><tr><td>Scala</td><td style=text-align:left>9.896</td></tr><tr><td>Crystal</td><td style=text-align:left>5.171</td></tr><tr><td>C</td><td style=text-align:left>5.038</td></tr></tbody></table><p>To have a better understanding of what is happening, I&rsquo;ve decided to profile and benchmark that code (running on <a href=/python.html>Python</a> 3.6).</p><p>The code is the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>random</span><span style=font-weight:700>,</span> <span style=color:#555>math</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>gibbs</span>(N<span style=font-weight:700>=</span><span style=color:#099>50000</span>, thin<span style=font-weight:700>=</span><span style=color:#099>1000</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	x <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	y <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	<span style=color:#999>print</span>(<span style=color:#b84>&#34;Iter x y&#34;</span>)
</span></span><span style=display:flex><span>	<span style=font-weight:700>for</span> i <span style=font-weight:700>in</span> <span style=color:#999>range</span>(N):
</span></span><span style=display:flex><span>		<span style=font-weight:700>for</span> j <span style=font-weight:700>in</span> <span style=color:#999>range</span>(thin):
</span></span><span style=display:flex><span>			x <span style=font-weight:700>=</span> random<span style=font-weight:700>.</span>gammavariate(<span style=color:#099>3</span>, <span style=color:#099>1.0</span> <span style=font-weight:700>/</span> (y y <span style=font-weight:700>+</span> <span style=color:#099>4</span>))
</span></span><span style=display:flex><span>			y <span style=font-weight:700>=</span> random<span style=font-weight:700>.</span>gauss(<span style=color:#099>1.0</span> <span style=font-weight:700>/</span> (x <span style=font-weight:700>+</span> <span style=color:#099>1</span>), <span style=color:#099>1.0</span> <span style=font-weight:700>/</span> math<span style=font-weight:700>.</span>sqrt(<span style=color:#099>2</span> x <span style=font-weight:700>+</span> <span style=color:#099>2</span>))
</span></span><span style=display:flex><span>			<span style=color:#999>print</span>(i,x,y)
</span></span></code></pre></div><p>Profiling this code with <code>cProfile</code> gives the following results:</p><table><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Call count</th><th>Time (ms)</th><th>Percentage</th></tr></thead><tbody><tr><td style=text-align:left>gammavariate</td><td style=text-align:left>50000000</td><td>141267</td><td>52.1%</td></tr><tr><td style=text-align:left>gauss</td><td style=text-align:left>50000000</td><td>65689</td><td>24.2%</td></tr><tr><td style=text-align:left><code>&lt;built-in method math.log></code></td><td style=text-align:left>116628436</td><td>18825</td><td>6.9%</td></tr><tr><td style=text-align:left><code>&lt;method 'random' of '_random.Random' objects></code></td><td style=text-align:left>170239973</td><td>17155</td><td>6.3%</td></tr><tr><td style=text-align:left><code>&lt;built-in method math.sqrt></code></td><td style=text-align:left>125000000</td><td>12352</td><td>4.6%</td></tr><tr><td style=text-align:left><code>&lt;built-in method math.exp></code></td><td style=text-align:left>60119980</td><td>7276</td><td>2.7%</td></tr><tr><td style=text-align:left><code>&lt;built-in method math.cos></code></td><td style=text-align:left>25000000</td><td>3338</td><td>1.2%</td></tr><tr><td style=text-align:left><code>&lt;built-in method math.sin></code></td><td style=text-align:left>25000000</td><td>3336</td><td>1.2%</td></tr><tr><td style=text-align:left><code>&lt;built-in method builtins.print></code></td><td style=text-align:left>50001</td><td>1030</td><td>0.4%</td></tr><tr><td style=text-align:left>gibbs.py</td><td style=text-align:left>1</td><td>271396</td><td>100.0%</td></tr></tbody></table><p>The results look different than the original ones on account of being performed on a different machine. However, we will just look into the relative code performance between different implementations and whether the code itself has room for optimisation.</p><p>Surprisingly, the console I/O took a much smaller proportion of the execution time than I expected (0.4%).</p><p>On the other hand, as expected, the bulk of the execution time is spent on the <code>gammavariate</code> and <code>gauss</code> methods.</p><p>These methods, however, are provided by the Python&rsquo;s standard library <code>random</code>, which underneath makes heavy usage of <code>C</code> code (mainly by <a href=https://github.com/python/cpython/blob/master/Lib/random.py#L35>usage</a> of the <code>random()</code> function).</p><p>For the second run of the code, I&rsquo;ve decided to use <code>numpy</code> to sample from the Gamma and Normal distributions. The new code, <code>gibbs_np.py</code>, is provided below.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>numpy</span> <span style=font-weight:700>as</span> <span style=color:#555>np</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>math</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>gibbs</span>(N<span style=font-weight:700>=</span><span style=color:#099>50000</span>, thin<span style=font-weight:700>=</span><span style=color:#099>1000</span>):
</span></span><span style=display:flex><span>	x <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	y <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	<span style=color:#999>print</span>(<span style=color:#b84>&#34;Iter x y&#34;</span>)
</span></span><span style=display:flex><span>	<span style=font-weight:700>for</span> i <span style=font-weight:700>in</span> <span style=color:#999>range</span>(N):
</span></span><span style=display:flex><span>		<span style=font-weight:700>for</span> j <span style=font-weight:700>in</span> <span style=color:#999>range</span>(thin):
</span></span><span style=display:flex><span>			x <span style=font-weight:700>=</span> np<span style=font-weight:700>.</span>random<span style=font-weight:700>.</span>gamma(<span style=color:#099>3</span>, <span style=color:#099>1.0</span> <span style=font-weight:700>/</span> (y y <span style=font-weight:700>+</span> <span style=color:#099>4</span>))
</span></span><span style=display:flex><span>			y <span style=font-weight:700>=</span> np<span style=font-weight:700>.</span>random<span style=font-weight:700>.</span>normal(<span style=color:#099>1.0</span> <span style=font-weight:700>/</span> (x <span style=font-weight:700>+</span> <span style=color:#099>1</span>), <span style=color:#099>1.0</span> <span style=font-weight:700>/</span> math<span style=font-weight:700>.</span>sqrt(<span style=color:#099>2</span> x <span style=font-weight:700>+</span> <span style=color:#099>2</span>))
</span></span><span style=display:flex><span>			<span style=color:#999>print</span>(i,x,y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>if</span> __name__ <span style=font-weight:700>==</span> <span style=color:#b84>&#34;main&#34;</span>:
</span></span><span style=display:flex><span>	gibbs()
</span></span></code></pre></div><p>We can see from the plots below that the results from both modules are identical.</p><figure><img src=/site/images/gibbs_modules.png alt=gibbs_modules.png></figure><p>The profiling results for the <code>numpy</code> version were:</p><table><thead><tr><th>Name</th><th>Call count</th><th>Time (ms)</th><th>Percentage</th></tr></thead><tbody><tr><td><code>&lt;method 'gamma' of 'mtrand.RandomState' objects></code></td><td>50000000</td><td>121211</td><td>45.8%</td></tr><tr><td><code>&lt;method 'normal' of 'mtrand.RandomState' objects></code></td><td>50000000</td><td>83092</td><td>31.4%</td></tr><tr><td><code>&lt;built-in method math.sqrt></code></td><td>50000000</td><td>6127</td><td>2.3%</td></tr><tr><td><code>&lt;built-in method builtins.print></code></td><td>50001</td><td>920</td><td>0.3%</td></tr><tr><td><code>gibbs_np.py</code></td><td>1</td><td>264420</td><td>100.0%</td></tr></tbody></table><p>A few interesting results from this benchmark were the fact that using <code>numpy</code> or <code>random</code> didn&rsquo;t make much difference overall (264.4 and 271.3 seconds, respectively).</p><p>This is despite the fact that, apparently, the Gamma sampling seems to perform better in <code>numpy</code> but the Normal sampling seems to be faster in the <code>random</code> library.</p><p>You will notice that we&rsquo;ve still used Python&rsquo;s built-in <code>math.sqrt</code> since it is known that for scalar usage it out-performs <code>numpy</code>&rsquo;s equivalent.</p><p>Unfortunately, in my view, we are just witnessing a fact of life: <em>Python is not the best language for number crunching</em>.</p><p>Since the bulk of the computational time, as we&rsquo;ve seen, is due to the sampling of the Normal and Gamma distributions, it is clear that in our code there is little room for optimisation except the sampling methods themselves.</p><p>A few possible solutions would be to:</p><ul><li>Convert the code to <code>Cython</code></li><li>Use FFI to call a highly optimised native library which provides Gamma and Normal distributions (such as <a href=https://www.gnu.org/software/gsl/>GSL</a>)</li></ul><p>Nevertheless, personally I still find Python a great language for quick prototyping of algorithms and with an excellent scientific computing libraries ecosystem. Keep on <em>Pythoning</em>.</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents></nav></div><div id=share-footer style=display:none></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Rui Vieira</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/css/fa.min.css><script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/mark.min.js></script>
<script src=/js/main.js></script></html>