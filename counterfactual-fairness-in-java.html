<!doctype html><html lang=en-uk><head><script data-goatcounter=https://ruivieira-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js></script>
<script src=https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js></script>
<script type=module src=/js/deeplinks/deeplinks.js></script>
<link rel=preload href=/lib/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/firacode/FiraCode-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/prociono/Prociono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=stylesheet href=/css/kbd.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Counterfactual Fairness in Java Â· Rui Vieira</title><link rel=canonical href=/counterfactual-fairness-in-java.html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Counterfactual Fairness in Java"><meta property="og:description" content="Here we will look at how to build a counterfactually fair model, as detailed in Counterfactual Fairness, specifically the &ldquo;Fair Add&rdquo; model.
This implementation will rely mostly on Apache Commons Math1 linear regression implementations, namely the Ordinary Least Squares (OLS) regression2. We start then by adding the relevant Maven dependencies:
<dependency> <groupId>org.apache.commons</groupId> <artifactId>commons-math3</artifactId> <version>3.6.1</version> </dependency> Data will be passed as a RealMatrix3. This matrix will have dimensions $N\times f$, where $N$ is the number of observations and $f$ is the number of features."><meta property="og:type" content="article"><meta property="og:url" content="/counterfactual-fairness-in-java.html"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2023-01-03T11:19:45+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Counterfactual Fairness in Java"><meta name=twitter:description content="Here we will look at how to build a counterfactually fair model, as detailed in Counterfactual Fairness, specifically the &ldquo;Fair Add&rdquo; model.
This implementation will rely mostly on Apache Commons Math1 linear regression implementations, namely the Ordinary Least Squares (OLS) regression2. We start then by adding the relevant Maven dependencies:
<dependency> <groupId>org.apache.commons</groupId> <artifactId>commons-math3</artifactId> <version>3.6.1</version> </dependency> Data will be passed as a RealMatrix3. This matrix will have dimensions $N\times f$, where $N$ is the number of observations and $f$ is the number of features."><link rel=stylesheet href=/css/styles.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=images/favicon.ico></head><body class="max-width mx-auto px3 ltr" x-data="{currentHeading: undefined}"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></span><br><div id=share style=display:none></div><div id=toc><h4>Contents</h4><nav id=TableOfContents><ul></ul></nav></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Counterfactual Fairness in Java</h1><div class=meta><div class=postdate>Updated <time datetime="2023-01-03 11:19:45 +0000 GMT" itemprop=datePublished>2023-01-03</time>
<span class=commit-hash>(<a href=/log/index.html#1285d4e>1285d4e</a>)</span></div></div></header><div class=content itemprop=articleBody><p>Here we will look at how to build a counterfactually fair model, as detailed in <a href=/counterfactual-fairness.html>Counterfactual Fairness</a>, specifically the &ldquo;Fair Add&rdquo; model.</p><p>This implementation will rely mostly on Apache Commons Math<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> linear regression implementations, namely the Ordinary Least Squares (OLS) regression<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. We start then by adding the relevant Maven dependencies:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:navy>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;groupId&gt;</span>org.apache.commons<span style=color:navy>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;artifactId&gt;</span>commons-math3<span style=color:navy>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;version&gt;</span>3.6.1<span style=color:navy>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Data will be passed as a <code>RealMatrix</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. This matrix will have dimensions $N\times f$, where $N$ is the number of observations and $f$ is the number of features.</p><p>We can instatiate the model using</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#998;font-style:italic>// RealMatrix data = ...
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=font-weight:700>final</span> CounterfactuallyFairModel model <span style=font-weight:700>=</span> <span style=font-weight:700>new</span> CounterfactuallyFairModel<span style=font-weight:700>(</span>data<span style=font-weight:700>);</span>
</span></span></code></pre></div><p>We will then need the following information:</p><ul><li>The protected attributes indices, <code>protectedIndices</code></li><li>The variable indices, <code>variableIndices</code></li><li>The target variable index, <code>targetIndex</code></li></ul><p>Assuming that we have the same variables as in the <a href=/counterfactual-fairness.html>counterfactual fairness example</a>, let&rsquo;s say that the protected attributes have in the <code>data</code> matrix, column numbers <code>5, 6, 7, 8, 9, 10, 11, 12, 13, 14</code> and the model variables (<code>LSAT</code> and <code>UGPA</code>) have indices <code>1, 0</code> and the target (<code>ZFYA</code>) has index <code>2</code>. We then calculate the counterfactually fair model using:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>model<span style=font-weight:700>.</span><span style=color:teal>calculate</span><span style=font-weight:700>(</span><span style=font-weight:700>new</span> <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]{</span>5<span style=font-weight:700>,</span> 6<span style=font-weight:700>,</span> 7<span style=font-weight:700>,</span> 8<span style=font-weight:700>,</span> 9<span style=font-weight:700>,</span> 10<span style=font-weight:700>,</span> 11<span style=font-weight:700>,</span> 12<span style=font-weight:700>,</span> 13<span style=font-weight:700>,</span> 14<span style=font-weight:700>},</span>
</span></span><span style=display:flex><span>			 <span style=font-weight:700>new</span> <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]{</span>1<span style=font-weight:700>,</span> 0<span style=font-weight:700>},</span> 2<span style=font-weight:700>);</span>
</span></span></code></pre></div><p>The <code>calculate</code> method performs the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>calculate</span><span style=font-weight:700>(</span><span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]</span> protectedIndices<span style=font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]</span> variableIndices<span style=font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> targetIndex<span style=font-weight:700>)</span> <span style=font-weight:700>{</span>  
</span></span><span style=display:flex><span>	<span style=font-weight:700>final</span> RealMatrix residuals <span style=font-weight:700>=</span> <span style=font-weight:700>new</span>
</span></span><span style=display:flex><span>		Array2DRowRealMatrix<span style=font-weight:700>(</span><span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>data</span><span style=font-weight:700>.</span><span style=color:teal>getRowDimension</span><span style=font-weight:700>(),</span> 
</span></span><span style=display:flex><span>		variableIndices<span style=font-weight:700>.</span><span style=color:teal>length</span><span style=font-weight:700>);</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>for</span> <span style=font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> i <span style=font-weight:700>=</span> 0<span style=font-weight:700>;</span> i <span style=font-weight:700>&lt;</span> variableIndices<span style=font-weight:700>.</span><span style=color:teal>length</span><span style=font-weight:700>;</span> i<span style=font-weight:700>++)</span> <span style=font-weight:700>{</span>  
</span></span><span style=display:flex><span>		<span style=font-weight:700>final</span> <span style=color:#458;font-weight:700>int</span> index <span style=font-weight:700>=</span> variableIndices<span style=font-weight:700>[</span>i<span style=font-weight:700>];</span>  
</span></span><span style=display:flex><span>		<span style=font-weight:700>final</span> RealVector varResidual <span style=font-weight:700>=</span> 
</span></span><span style=display:flex><span>			<span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>calculateEpsilon</span><span style=font-weight:700>(</span>protectedIndices<span style=font-weight:700>,</span> index<span style=font-weight:700>);</span>  
</span></span><span style=display:flex><span>		residuals<span style=font-weight:700>.</span><span style=color:teal>setColumn</span><span style=font-weight:700>(</span>i<span style=font-weight:700>,</span> varResidual<span style=font-weight:700>.</span><span style=color:teal>toArray</span><span style=font-weight:700>());</span>  
</span></span><span style=display:flex><span>	<span style=font-weight:700>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic>// predict target from residuals  
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=font-weight:700>final</span> OLSMultipleLinearRegression regression <span style=font-weight:700>=</span> <span style=font-weight:700>new</span>
</span></span><span style=display:flex><span>		OLSMultipleLinearRegression<span style=font-weight:700>();</span>  
</span></span><span style=display:flex><span>	regression<span style=font-weight:700>.</span><span style=color:teal>newSampleData</span><span style=font-weight:700>(</span><span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>data</span><span style=font-weight:700>.</span><span style=color:teal>getColumn</span><span style=font-weight:700>(</span>targetIndex<span style=font-weight:700>),</span> 
</span></span><span style=display:flex><span>		residuals<span style=font-weight:700>.</span><span style=color:teal>getData</span><span style=font-weight:700>());</span>  
</span></span><span style=display:flex><span><span style=font-weight:700>}</span>
</span></span></code></pre></div><p>As in <a href=/counterfactual-fairness.html>counterfactual Fairness</a> , we calculate a regression model to predict each of the variable (<code>LSAT</code> and <code>UGPA</code>) using the protected variables. The resulting residuals, $\epsilon_{LSAT}$ and $\epsilon_{UGPA}$ will in turn be used to calculate another regression model in order to predict the target variable <code>ZFYA</code>.</p><p>The residuals are calculated using the <code>calculateEpsilon</code> method, which consists of:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> RealVector <span style=color:#900;font-weight:700>calculateEpsilon</span><span style=font-weight:700>(</span><span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]</span> protectedIndices<span style=font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> targetIndex<span style=font-weight:700>)</span> <span style=font-weight:700>{</span>  
</span></span><span style=display:flex><span>	<span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]</span> protectedRows <span style=font-weight:700>=</span> <span style=font-weight:700>new</span> <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[</span><span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>data</span><span style=font-weight:700>.</span><span style=color:teal>getRowDimension</span><span style=font-weight:700>()];</span>  
</span></span><span style=display:flex><span>    Arrays<span style=font-weight:700>.</span><span style=color:teal>setAll</span><span style=font-weight:700>(</span>protectedRows<span style=font-weight:700>,</span> i <span style=font-weight:700>-&gt;</span> i<span style=font-weight:700>);</span>  
</span></span><span style=display:flex><span>    <span style=font-weight:700>final</span> RealMatrix _x <span style=font-weight:700>=</span> <span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>data</span><span style=font-weight:700>.</span><span style=color:teal>getSubMatrix</span><span style=font-weight:700>(</span>protectedRows<span style=font-weight:700>,</span>
</span></span><span style=display:flex><span>		protectedIndices<span style=font-weight:700>);</span>  
</span></span><span style=display:flex><span>    <span style=font-weight:700>final</span> RealVector _y <span style=font-weight:700>=</span> <span style=font-weight:700>this</span><span style=font-weight:700>.</span><span style=color:teal>data</span><span style=font-weight:700>.</span><span style=color:teal>getSubMatrix</span><span style=font-weight:700>(</span>protectedRows<span style=font-weight:700>,</span> 
</span></span><span style=display:flex><span>		<span style=font-weight:700>new</span> <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>[]{</span>targetIndex<span style=font-weight:700>}).</span><span style=color:teal>getColumnVector</span><span style=font-weight:700>(</span>0<span style=font-weight:700>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=font-weight:700>final</span> OLSMultipleLinearRegression regression <span style=font-weight:700>=</span> <span style=font-weight:700>new</span>
</span></span><span style=display:flex><span>		OLSMultipleLinearRegression<span style=font-weight:700>();</span>  
</span></span><span style=display:flex><span>	regression<span style=font-weight:700>.</span><span style=color:teal>newSampleData</span><span style=font-weight:700>(</span>_y<span style=font-weight:700>.</span><span style=color:teal>toArray</span><span style=font-weight:700>(),</span> _x<span style=font-weight:700>.</span><span style=color:teal>getData</span><span style=font-weight:700>());</span>  
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> <span style=font-weight:700>new</span> ArrayRealVector<span style=font-weight:700>(</span>regression<span style=font-weight:700>.</span><span style=color:teal>estimateResiduals</span><span style=font-weight:700>());</span>  
</span></span><span style=display:flex><span><span style=font-weight:700>}</span>
</span></span></code></pre></div><p>Which simply calculates a regression model for the variables using the protected attributes and returning a <code>RealVector</code> with the residual $\epsilon$.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://commons.apache.org/proper/commons-math/>https://commons.apache.org/proper/commons-math/</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://commons.apache.org/proper/commons-math/javadocs/api-3.6/org/apache/commons/math3/stat/regression/OLSMultipleLinearRegression.html>https://commons.apache.org/proper/commons-math/javadocs/api-3.6/org/apache/commons/math3/stat/regression/OLSMultipleLinearRegression.html</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://commons.apache.org/proper/commons-math/javadocs/api-3.6/org/apache/commons/math3/linear/RealMatrix.html>https://commons.apache.org/proper/commons-math/javadocs/api-3.6/org/apache/commons/math3/linear/RealMatrix.html</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents></nav></div><div id=share-footer style=display:none></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Rui Vieira</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/css/fa.min.css><script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/mark.min.js></script>
<script src=/js/main.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>