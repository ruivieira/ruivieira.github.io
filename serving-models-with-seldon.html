<!DOCTYPE html>
<html lang="en-uk">
<head>
  <script data-goatcounter="https://ruivieira-dev.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  <script type="module" src="/js/deeplinks/deeplinks.js"></script>
  <link rel="preload" href="/lib/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/kbd.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Serving models with Seldon | Rui Vieira</title>
  <link rel = 'canonical' href = 'https://ruivieira.dev/serving-models-with-seldon.html'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Serving models with Seldon" />
<meta property="og:description" content="Deploying machine learning models in production comes with several requirements. We must manage the model lifecycle. We need reproducibility and typically use containerised workflows.
Seldon is a tool which aims at providing a production workflow for machine learning models, allowing to build model serving containers which expose well-defined APIs.
In this post, I&rsquo;ll show how to create a simple model and how to deploy it with Seldon. The model is a customer segmentation one." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ruivieira.dev/serving-models-with-seldon.html" /><meta property="article:section" content="posts" />

<meta property="article:modified_time" content="2021-11-25T08:28:11+00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Serving models with Seldon"/>
<meta name="twitter:description" content="Deploying machine learning models in production comes with several requirements. We must manage the model lifecycle. We need reproducibility and typically use containerised workflows.
Seldon is a tool which aims at providing a production workflow for machine learning models, allowing to build model serving containers which expose well-defined APIs.
In this post, I&rsquo;ll show how to create a simple model and how to deploy it with Seldon. The model is a customer segmentation one."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://ruivieira.dev/css/styles.a79457dee09605722c187170e1f001057207e2c93fc96404bb2a6c4cb05cd5f21213b095a3d9073117560bf616c0b96c897a1b862847d6a669e830262706cc68.css" integrity="sha512-p5RX3uCWBXIsGHFw4fABBXIH4sk/yWQEuypsTLBc1fISE7CVo9kHMRdWC/YWwLlsiXobhihH1qZp6DAmJwbMaA=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://ruivieira.dev/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/map/">All pages</a></li>
         
        <li><a href="/search.html">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://ruivieira.dev/shell-configurations.html" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://ruivieira.dev/search.html" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&text=Serving%20models%20with%20Seldon" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&is_video=false&description=Serving%20models%20with%20Seldon" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Serving%20models%20with%20Seldon&body=Check out this article: https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&name=Serving%20models%20with%20Seldon&description=Deploying%20machine%20learning%20models%20in%20production%20comes%20with%20several%20requirements.%20We%20must%20manage%20the%20model%20lifecycle.%20We%20need%20reproducibility%20and%20typically%20use%20containerised%20workflows.%0aSeldon%20is%20a%20tool%20which%20aims%20at%20providing%20a%20production%20workflow%20for%20machine%20learning%20models%2c%20allowing%20to%20build%20model%20serving%20containers%20which%20expose%20well-defined%20APIs.%0aIn%20this%20post%2c%20I%26rsquo%3bll%20show%20how%20to%20create%20a%20simple%20model%20and%20how%20to%20deploy%20it%20with%20Seldon.%20The%20model%20is%20a%20customer%20segmentation%20one." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&t=Serving%20models%20with%20Seldon" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    
    <div id="toc">
      <h4>Contents</h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#create-data">Create data</a></li>
    <li><a href="#train-model">Train model</a></li>
    <li><a href="#deploy-model">Deploy model</a>
      <ul>
        <li><a href="#simple-model">Simple model</a></li>
        <li><a href="#with-metrics">With metrics</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
      </ul>
    </nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Serving models with Seldon
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          Updated <time datetime="2021-11-25 08:28:11 &#43;0000 GMT" itemprop="datePublished">2021-11-25</time>
          <span class="commit-hash">(2caaeb5)</span>
        </div>
        
        
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>Deploying machine learning models in production comes with several requirements.
We must manage the model lifecycle. We need reproducibility and typically use containerised workflows.</p>
<p><a href="https://github.com/SeldonIO/seldon-core">Seldon</a> is a tool which aims at providing a production workflow for machine learning models, allowing to build model serving containers which expose well-defined APIs.</p>
<p>In this post, I&rsquo;ll show how to create a simple model and how to deploy it with Seldon. The model is a customer segmentation one. The goal is to classify a customer according to a segment (0, 1 or 2), according to its age, income, whether they engaged with previous campaigns and the campaign type.</p>
<p>Once we train the model, we deploy it with Seldon in a container orchestration
platform such as <a href="https://kubernetes.io/">Kubernetes</a> and <a href="https://www.openshift.com/">OpenShift</a>.</p>
<h2 id="create-data">Create data</h2>
<p>We use the Python&rsquo;s <a href="https://scikit-learn.org/stable/">`scikit-learn`</a> to train our model.
However, we must first simulate some data to train it.
We start by simulating the users age (\(a\)) and income (\(c\)). We assume income is correlated with age.</p>
<p>\begin{aligned}
c|a &amp;\sim \mathcal{N}\left(a + 20, 100\right)  \\\\
a|k &amp;\sim \mathcal{U}\left(A_k, B_k\right),\quad A=\left\lbrace16, 25, 50, 61\right\rbrace,B=\left\lbrace24, 49, 60, 90\right\rbrace  \\\\
k &amp;\sim \mathcal{M}\left(4, \left\lbrace 0.15, 0.4, 0.2, 0.25\right\rbrace\right)
\end{aligned}</p>
<figure><img src="/ox-hugo/seldon_segments.png"/>
</figure>

<p>Let&rsquo;s assume we have eight distinct events (\(e=\left(0, 1, \dots, 7\right)\)). We sample them from a multinomial
distribution and also assume that two different age bands have different distributions, just to add some variation.</p>
<p>\[
e = \begin{cases} \mathcal{M}\left(7, \left\lbrace 0.026, 0.195, 0.156, 0.208, 0.130, 0.205, 0.078 \right\rbrace\right) &amp; \text{if}\ a &lt; 50 \\\\
\mathcal{M}\left(7, \left\lbrace 0.052, 0.143, 0.169, 0.182, 0.164, 0.182, 0.104 \right\rbrace\right) &amp; \text{if}\ a \geq 50
\end{cases}
\]</p>
<figure><img src="/ox-hugo/seldon_hist_event_income.png"/>
</figure>

<p>The responses are calculated as `0` or `1`, representing &ldquo;true&rdquo; or &ldquo;false&rdquo;, and sampled from Bernoulli
distributions, with different distributions depending on the event, again just to add some variation.</p>
<p>\[
r = \begin{cases}
\text{Bernoulli}\left(0.6\right) &amp; \text{if}\ e \in \left(2, 3, 4, 6\right) \\\\
\text{Bernoulli}\left(0.4\right) &amp; \text{if}\ e \in \left(1, 5, 7\right)
\end{cases}
\]</p>
<p>To predict the response of a customer, we use a logistic model, with coefficients \(\beta_{age}=-0.0004\) and \(\beta_{income}=0.0001\). For the customer level, we use a negative binomial model with coefficients \(\beta_{age}=-0.0233\) and \(\beta_{income}=0.0054\).
This results in the following distribution of customer levels:</p>
<figure><img src="/ox-hugo/seldon_level.png"/>
</figure>

<p>Finally, we create the response according to negative binomial model with coefficients \(\beta_{level}=0.1862\) and \(\beta_{response}=0.2076\). We get the following segments, stratified by age and income:</p>
<figure><img src="/ox-hugo/seldon_segments.png"/>
</figure>

<h2 id="train-model">Train model</h2>
<p>Now that we have our simulated data, we can train a model.
Generally, it is straightforward to train model data when in `pandas` data frame format.
Let&rsquo;s proceed with creating a data frame with the data we&rsquo;ve just generated:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="font-weight:bold">as</span> <span style="color:#555">pd</span>

data <span style="font-weight:bold">=</span> {
    <span style="color:#b84">&#34;age&#34;</span>: age,
    <span style="color:#b84">&#34;income&#34;</span>: income,
    <span style="color:#b84">&#34;class&#34;</span>: _class,
    <span style="color:#b84">&#34;response&#34;</span>: response,
    <span style="color:#b84">&#34;segment&#34;</span>: segment,
    <span style="color:#b84">&#34;events&#34;</span>: events,
}

df <span style="font-weight:bold">=</span> pd<span style="font-weight:bold">.</span>DataFrame(data)
</code></pre></div><p>We now create the training and testing datasets. The first thing is to define the classifier&rsquo;s `inputs` and `outputs` and then splitting each of them into training and testing. Here I have used a split of 60%/40% for training and testing respectively.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">from</span> <span style="color:#555">sklearn.model_selection</span> <span style="font-weight:bold">import</span> train_test_split

cols <span style="font-weight:bold">=</span> [<span style="color:#b84">&#34;age&#34;</span>, <span style="color:#b84">&#34;income&#34;</span>, <span style="color:#b84">&#34;response&#34;</span>, <span style="color:#b84">&#34;events&#34;</span>]
inputs <span style="font-weight:bold">=</span> df[cols]
outputs <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#34;segment&#34;</span>]

<span style="color:#998;font-style:italic"># split dataset</span>
X_train, X_test, y_train, y_test <span style="font-weight:bold">=</span> train_test_split(
    inputs, outputs, test_size<span style="font-weight:bold">=</span><span style="color:#099">0.4</span>, random_state<span style="font-weight:bold">=</span><span style="color:#099">23</span>
)
</code></pre></div><p>We use a Random Forest classifier as the underlying algorithm for our model.
These are available in `sciki-learn` with the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">`RandomForestClassifier`</a> class.
However, `scikit-learn` does not support categorical variables out of the box<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.
To deal with them, we build a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">`Pipeline`</a>, which allows to chain multiple transformations to our data, including a categorical variable processor, such as <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">`OrdinalEncoder`</a><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.
We use <a href="https://github.com/scikit-learn-contrib/sklearn-pandas">`DataFrameMapper`</a> to apply the encoder to the `response` and `events` columns and leave the remaining unchanged.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">from</span> <span style="color:#555">sklearn.ensemble</span> <span style="font-weight:bold">import</span> RandomForestClassifier
<span style="font-weight:bold">from</span> <span style="color:#555">sklearn</span> <span style="font-weight:bold">import</span> preprocessing
<span style="font-weight:bold">from</span> <span style="color:#555">sklearn.pipeline</span> <span style="font-weight:bold">import</span> Pipeline


<span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">build_RF_pipeline</span>(inputs, outputs, rf<span style="font-weight:bold">=</span><span style="font-weight:bold">None</span>):
    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> rf:
        rf <span style="font-weight:bold">=</span> RandomForestClassifier()

    pipeline <span style="font-weight:bold">=</span> Pipeline(
        [
            (
                <span style="color:#b84">&#34;mapper&#34;</span>,
                DataFrameMapper(
                    [
                        ([<span style="color:#b84">&#34;response&#34;</span>, <span style="color:#b84">&#34;events&#34;</span>], preprocessing<span style="font-weight:bold">.</span>OrdinalEncoder()),
                        ([<span style="color:#b84">&#34;age&#34;</span>, <span style="color:#b84">&#34;income&#34;</span>], <span style="font-weight:bold">None</span>),
                    ]
                ),
            ),
            (<span style="color:#b84">&#34;classifier&#34;</span>, rf),
        ]
    )
    pipeline<span style="font-weight:bold">.</span>fit(inputs, outputs)
    <span style="font-weight:bold">return</span> pipeline
</code></pre></div><p>The actual training involves a simple hyper-parameter estimation using
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.model%5Fselection.RandomizedSearchCV.html">`RandomizedSearchCV`</a>. This method performs a type of parameter grid search but restricting the search to only the specified values. For the scope of this post, it is not necessary to perform an exhaustive hyperparameter estimation.
The `RF_estimation` function returns the best-fitted model after searching with the test dataset.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">RF_estimation</span>(
    inputs,
    outputs,
    estimator_steps<span style="font-weight:bold">=</span><span style="color:#099">10</span>,
    depth_steps<span style="font-weight:bold">=</span><span style="color:#099">10</span>,
    min_samples_split<span style="font-weight:bold">=</span><span style="font-weight:bold">None</span>,
    min_samples_leaf<span style="font-weight:bold">=</span><span style="font-weight:bold">None</span>,
):
    <span style="color:#998;font-style:italic"># hyper-parameter estimation</span>
    n_estimators <span style="font-weight:bold">=</span> [
        <span style="color:#999">int</span>(x) <span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> np<span style="font-weight:bold">.</span>linspace(start<span style="font-weight:bold">=</span><span style="color:#099">50</span>, stop<span style="font-weight:bold">=</span><span style="color:#099">100</span>, num<span style="font-weight:bold">=</span>estimator_steps)
    ]
    max_depth <span style="font-weight:bold">=</span> [<span style="color:#999">int</span>(x) <span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> np<span style="font-weight:bold">.</span>linspace(<span style="color:#099">3</span>, <span style="color:#099">10</span>, num<span style="font-weight:bold">=</span>depth_steps)]
    max_depth<span style="font-weight:bold">.</span>append(<span style="font-weight:bold">None</span>)
    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> min_samples_split:
        min_samples_split <span style="font-weight:bold">=</span> [<span style="color:#099">1</span>, <span style="color:#099">2</span>, <span style="color:#099">4</span>]
    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> min_samples_leaf:
        min_samples_leaf <span style="font-weight:bold">=</span> [<span style="color:#099">1</span>, <span style="color:#099">2</span>, <span style="color:#099">4</span>]
    bootstrap <span style="font-weight:bold">=</span> [<span style="font-weight:bold">True</span>, <span style="font-weight:bold">False</span>]
    random_grid <span style="font-weight:bold">=</span> {
        <span style="color:#b84">&#34;n_estimators&#34;</span>: n_estimators,
        <span style="color:#b84">&#34;max_depth&#34;</span>: max_depth,
        <span style="color:#b84">&#34;min_samples_split&#34;</span>: min_samples_split,
        <span style="color:#b84">&#34;min_samples_leaf&#34;</span>: min_samples_leaf,
        <span style="color:#b84">&#34;bootstrap&#34;</span>: bootstrap,
    }

    rf_random <span style="font-weight:bold">=</span> RandomizedSearchCV(
        estimator<span style="font-weight:bold">=</span>RandomForestClassifier(),
        param_distributions<span style="font-weight:bold">=</span>random_grid,
        n_iter<span style="font-weight:bold">=</span><span style="color:#099">100</span>,
        scoring<span style="font-weight:bold">=</span><span style="color:#b84">&#34;neg_mean_absolute_error&#34;</span>,
        cv<span style="font-weight:bold">=</span><span style="color:#099">3</span>,
        verbose<span style="font-weight:bold">=</span><span style="color:#099">1</span>,
        random_state<span style="font-weight:bold">=</span><span style="color:#099">42</span>,
        n_jobs<span style="font-weight:bold">=-</span><span style="color:#099">1</span>,
    )
    rf_random<span style="font-weight:bold">.</span>fit(inputs, outputs)
    best_random <span style="font-weight:bold">=</span> rf_random<span style="font-weight:bold">.</span>best_estimator_

    <span style="font-weight:bold">return</span> best_random
</code></pre></div><p>After applying the parameter estimation, we take the best scoring model and calculate the MSE. Unsurprisingly (given the simple model and simulated data), we get a very good fit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">rf_predictions <span style="font-weight:bold">=</span> random_forest_pipeline<span style="font-weight:bold">.</span>predict(X_test)
<span style="color:#999">print</span>(<span style="color:#b84">f</span><span style="color:#b84">&#34;MSE: </span><span style="color:#b84">{</span>random_forest_pipeline<span style="font-weight:bold">.</span>score(X_test, y_test)<span style="font-weight:bold">*</span><span style="color:#099">100</span><span style="color:#b84">}</span><span style="color:#b84">%&#34;</span>)
<span style="color:#998;font-style:italic"># MSE: 99.95%</span>
</code></pre></div><p>The final step is serialising the model. Serialisation is necessary since we only serve the pre-trained model.
To do so, we use the <a href="https://github.com/joblib/joblib">`joblib`</a> library and save the model to a `model.pkl` file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">import</span> <span style="color:#555">joblib</span>

<span style="color:#998;font-style:italic"># save mode in filesystem</span>
joblib<span style="font-weight:bold">.</span>dump(random_forest_pipeline, <span style="color:#b84">&#34;model.pkl&#34;</span>)

</code></pre></div><h2 id="deploy-model">Deploy model</h2>
<p>It is important to note that we don&rsquo;t need the model training code included in the Seldon server. The purpose of Seldon is not to <strong>train</strong> models, but to <strong>deploy</strong> them and manage their lifecycle.
This workflow means that a typical Seldon deployment would only include the prediction endpoint implementation and a serialised model.
This provision is made by firstly create a <strong>wrapper</strong> for our model which implements the Seldon endpoints.</p>
<h3 id="simple-model">Simple model</h3>
<p>We create a Python script called `Model.py`Â <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.
The primary prediction endpoint uses the following signature:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">predict</span>(self, X: np<span style="font-weight:bold">.</span>ndarray, names: Iterable[<span style="color:#999">str</span>], meta: Dict <span style="font-weight:bold">=</span> <span style="font-weight:bold">None</span>)
</code></pre></div><p>The wrapper is straightforward, in this example.
We use the `joblib` library again, to load the serialised model `model.pkl`, and then pass through any JSON payload as inputs (`X`) to the model to get a prediction as well as using Python&rsquo;s default <a href="https://docs.python.org/3/library/logging.html">logging</a>
to provide some feedback.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">import</span> <span style="color:#555">joblib</span>
<span style="font-weight:bold">import</span> <span style="color:#555">logging</span>


<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Model</span>(<span style="color:#999">object</span>):
    <span style="font-weight:bold">def</span> __init__(self):
        logger<span style="font-weight:bold">.</span>info(<span style="color:#b84">&#34;Initializing.&#34;</span>)
        logger<span style="font-weight:bold">.</span>info(<span style="color:#b84">&#34;Loading model.&#34;</span>)
        self<span style="font-weight:bold">.</span>model <span style="font-weight:bold">=</span> joblib<span style="font-weight:bold">.</span>load(<span style="color:#b84">&#34;model.pkl&#34;</span>)

    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">predict</span>(self, X, features_names):
        <span style="font-weight:bold">return</span> self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>predict_proba(X)
</code></pre></div><p>We now build the model using the `s2i` (<a href="https://github.com/openshift/source-to-image">source-to-image</a>).
As the name implies, `s2i`&rsquo;s allow to create a container image from source code, taking care of any necessary intermediate steps.
Seldon support several types of builds (such as Python, R and Java)<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>.</p>
<p>Typically `s2i`&rsquo;s rely on certain conventions (over configuration) on your application structure. A requirement when building a Seldon model using its `s2i` is to provide some specific environment variables. These are usually stored in a file located in `$REPO/.s2i/environment`. For instance, for this model we use:</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">MODEL_NAME=Model
API_TYPE=REST
SERVICE_TYPE=MODEL
PERSISTENCE=0
</code></pre><p>The `MODEL_NAME` corresponds to the script we&rsquo;ve created previously, `Model.py` and instructs Seldon to use it as the REST endpoint provider. `API_TYPE` defines the endpoint interface. We use the REST interface, other possibilities include gRPC, for instance.</p>
<figure><img src="/ox-hugo/diagram.png"/>
</figure>

<p>To build the container image using the `s2i`, assuming you want an image named `$NAME` and tagged with `$TAG`, we simply need to run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ s2i build <span style="color:#008080">$REPO</span> <span style="color:#b84">\
</span><span style="color:#b84"></span>  seldonio/seldon-core-s2i-python36:0.18 <span style="color:#b84">\
</span><span style="color:#b84"></span>  <span style="color:#008080">$NAME</span>:<span style="color:#008080">$TAG</span>
</code></pre></div><p>You can provide the location of your source code either by specifying a remote Git repository or by passing a local one.
Once the container image builds, you can now run it using, for instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker run -i --rm -p 5000:5000 <span style="color:#008080">$NAME</span>:<span style="color:#008080">$TAG</span>
</code></pre></div><p>Let&rsquo;s get a prediction from the model:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl --header <span style="color:#b84">&#34;Content-Type: application/json&#34;</span> <span style="color:#b84">\
</span><span style="color:#b84"></span>  --request POST <span style="color:#b84">\
</span><span style="color:#b84"></span>  --data <span style="color:#b84">&#39;{&#34;data&#34;:{&#34;ndarray&#34;:[[34.0, 100.0, 1, 2]]}}&#39;</span> <span style="color:#b84">\
</span><span style="color:#b84"></span>  http://localhost:5000/predict
</code></pre></div><p>This will return a prediction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000080">&#34;data&#34;</span>: {
        <span style="color:#000080">&#34;names&#34;</span>: [<span style="color:#b84">&#34;t:0&#34;</span>,<span style="color:#b84">&#34;t:1&#34;</span>,<span style="color:#b84">&#34;t:2&#34;</span>],
        <span style="color:#000080">&#34;ndarray&#34;</span>: [[<span style="color:#099">0.0</span>,<span style="color:#099">0.9980208571211083</span>,<span style="color:#099">0.00197914287889168</span>]]},
    <span style="color:#000080">&#34;meta&#34;</span>: {}
}
</code></pre></div><p>This response corresponds to the probability of each segment (`0`, `1` and `2`), respectively.
We can see that a customer with this profile is classified as a segment `1` with an associated probability of 99.8%.</p>
<h3 id="with-metrics">With metrics</h3>
<p>Seldon provides basic metrics by default, covering service, predictor and model name, version and image. However, you can directly add custom metrics. Going back to our `Model` wrapper class, we add a new method called `metrics` which returns custom metrics. The metrics are compatible with Prometheus and, therefore, the metric type should be familiar if you have dealt with Prometheus before. These include, for instance:</p>
<ul>
<li>Counters</li>
<li>Gauges</li>
<li>Timers</li>
</ul>
<p>Let&rsquo;s add to the wrapper:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="font-weight:bold">import</span> <span style="color:#555">joblib</span>
<span style="font-weight:bold">import</span> <span style="color:#555">logging</span>


<span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Model</span>(<span style="color:#999">object</span>):
    <span style="font-weight:bold">def</span> __init__(self):
        logger<span style="font-weight:bold">.</span>info(<span style="color:#b84">&#34;Initializing.&#34;</span>)
        logger<span style="font-weight:bold">.</span>info(<span style="color:#b84">&#34;Loading model.&#34;</span>)
        self<span style="font-weight:bold">.</span>model <span style="font-weight:bold">=</span> joblib<span style="font-weight:bold">.</span>load(<span style="color:#b84">&#34;model.pkl&#34;</span>)

    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">predict</span>(self, X, features_names):
        <span style="font-weight:bold">return</span> self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>predict_proba(X)

    <span style="color:#998;font-style:italic"># new custom metrics endpoint</span>
    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">metrics</span>(self):
        <span style="font-weight:bold">return</span> [
            <span style="color:#998;font-style:italic"># a counter which will increase by the given value</span>
            {<span style="color:#b84">&#34;type&#34;</span>: <span style="color:#b84">&#34;COUNTER&#34;</span>, <span style="color:#b84">&#34;key&#34;</span>: <span style="color:#b84">&#34;mycounter&#34;</span>, <span style="color:#b84">&#34;value&#34;</span>: <span style="color:#099">1</span>},
            <span style="color:#998;font-style:italic"># a gauge which will be set to given value</span>
            {<span style="color:#b84">&#34;type&#34;</span>: <span style="color:#b84">&#34;GAUGE&#34;</span>, <span style="color:#b84">&#34;key&#34;</span>: <span style="color:#b84">&#34;mygauge&#34;</span>, <span style="color:#b84">&#34;value&#34;</span>: <span style="color:#099">10</span>},
            <span style="color:#998;font-style:italic"># a timer which will add sum and count metrics - assumed millisecs</span>
            {<span style="color:#b84">&#34;type&#34;</span>: <span style="color:#b84">&#34;TIMER&#34;</span>, <span style="color:#b84">&#34;key&#34;</span>: <span style="color:#b84">&#34;mytimer&#34;</span>, <span style="color:#b84">&#34;value&#34;</span>: <span style="color:#099">1.1</span>},
        ]
</code></pre></div><p>If we now request a new prediction, as previously, we can see the custom metrics included in the model&rsquo;s response.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000080">&#34;data&#34;</span>: {
        <span style="color:#000080">&#34;names&#34;</span>: [<span style="color:#b84">&#34;t:0&#34;</span>,<span style="color:#b84">&#34;t:1&#34;</span>,<span style="color:#b84">&#34;t:2&#34;</span>],
        <span style="color:#000080">&#34;ndarray&#34;</span>:[[<span style="color:#099">0.0</span>,<span style="color:#099">0.9980208571211083</span>,<span style="color:#099">0.00197914287889168</span>]]},
    <span style="color:#000080">&#34;meta&#34;</span>: {
        <span style="color:#000080">&#34;metrics&#34;</span>: [
            {<span style="color:#000080">&#34;key&#34;</span>:<span style="color:#b84">&#34;mycounter&#34;</span>,<span style="color:#000080">&#34;type&#34;</span>:<span style="color:#b84">&#34;COUNTER&#34;</span>,<span style="color:#000080">&#34;value&#34;</span>:<span style="color:#099">1</span>},
            {<span style="color:#000080">&#34;key&#34;</span>:<span style="color:#b84">&#34;mygauge&#34;</span>,<span style="color:#000080">&#34;type&#34;</span>:<span style="color:#b84">&#34;GAUGE&#34;</span>,<span style="color:#000080">&#34;value&#34;</span>:<span style="color:#099">10</span>},
            {<span style="color:#000080">&#34;key&#34;</span>:<span style="color:#b84">&#34;mytimer&#34;</span>,<span style="color:#000080">&#34;type&#34;</span>:<span style="color:#b84">&#34;TIMER&#34;</span>,<span style="color:#000080">&#34;value&#34;</span>:<span style="color:#099">1.1</span>}]
    }
}
</code></pre></div><p>These values are available via the Prometheus endpoint.</p>
<p>The model can also be easily deployed in a container platform, for instance, OpenShift. Assuming you are logged to a cluster and your image is a registry accessible by OpenShift, you can simply deploy it using:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ oc new-app <span style="color:#008080">$NAME</span>:<span style="color:#008080">$TAG</span>
</code></pre></div><p>I hope this was useful to you.
Happy coding!</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>As of the time of writing.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Other encoders are available in `scikit-learn`. I recommend you experiment with some of them.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>You can use any file name, as long as it&rsquo;s consistent with `.s2i/environment`, which we&rsquo;ll look at soon.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>More information can be found <a href="https://docs.seldon.io/projects/seldon-core/en/latest/wrappers/s2i.html">here</a>.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>
  </article>



  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/map/">All pages</a></li>
         
          <li><a href="/search.html">Search</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#create-data">Create data</a></li>
    <li><a href="#train-model">Train model</a></li>
    <li><a href="#deploy-model">Deploy model</a>
      <ul>
        <li><a href="#simple-model">Simple model</a></li>
        <li><a href="#with-metrics">With metrics</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&text=Serving%20models%20with%20Seldon" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&is_video=false&description=Serving%20models%20with%20Seldon" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Serving%20models%20with%20Seldon&body=Check out this article: https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&title=Serving%20models%20with%20Seldon" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&name=Serving%20models%20with%20Seldon&description=Deploying%20machine%20learning%20models%20in%20production%20comes%20with%20several%20requirements.%20We%20must%20manage%20the%20model%20lifecycle.%20We%20need%20reproducibility%20and%20typically%20use%20containerised%20workflows.%0aSeldon%20is%20a%20tool%20which%20aims%20at%20providing%20a%20production%20workflow%20for%20machine%20learning%20models%2c%20allowing%20to%20build%20model%20serving%20containers%20which%20expose%20well-defined%20APIs.%0aIn%20this%20post%2c%20I%26rsquo%3bll%20show%20how%20to%20create%20a%20simple%20model%20and%20how%20to%20deploy%20it%20with%20Seldon.%20The%20model%20is%20a%20customer%20segmentation%20one." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fruivieira.dev%2fserving-models-with-seldon.html&t=Serving%20models%20with%20Seldon" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Rui Vieira 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/map/">All pages</a></li>
         
        <li><a href="/search.html">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/css/fa.min.css>
<script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/main.js></script>



  


<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</html>
