<!doctype html><html lang=en-uk><head><script data-goatcounter=https://ruivieira-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js></script>
<script src=https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js></script>
<script type=module src=/js/deeplinks/deeplinks.js></script>
<link rel=preload href=/lib/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/firacode/FiraCode-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/fonts/vollkorn/Vollkorn-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=stylesheet href=/css/kbd.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Streaming anomaly detection Â· Rui Vieira</title><link rel=canonical href=/streaming-anomaly-detection.html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Streaming anomaly detection"><meta property="og:description" content="Useful algorithms:
Conformalised density and distance-based anomaly detection in time-series data1 elford algorithm Anomaly detection in streams with extreme value theory Robust random cut forest based anomaly detection on streams2 Time-series anomaly detection service at Microsoft3 Half-Space Trees Experimental dataLet&rsquo;s assume the following sequence of observations that we will use with a variety of algorithms. The data is labelled with label with 0 for normal observations and 1 for anomalies."><meta property="og:type" content="article"><meta property="og:url" content="/streaming-anomaly-detection.html"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2023-09-02T17:28:34+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Streaming anomaly detection"><meta name=twitter:description content="Useful algorithms:
Conformalised density and distance-based anomaly detection in time-series data1 elford algorithm Anomaly detection in streams with extreme value theory Robust random cut forest based anomaly detection on streams2 Time-series anomaly detection service at Microsoft3 Half-Space Trees Experimental dataLet&rsquo;s assume the following sequence of observations that we will use with a variety of algorithms. The data is labelled with label with 0 for normal observations and 1 for anomalies."><link rel=stylesheet href=/css/styles.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=images/favicon.ico></head><body class="max-width mx-auto px3 ltr" x-data="{currentHeading: undefined}"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-eye fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/draw/>Drawings</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></span><br><div id=share style=display:none></div><div id=toc><h4>Contents</h4><nav id=TableOfContents><ul><li><a href=#experimental-data :class="{'toc-h2':true, 'toc-highlight': currentHeading == '#experimental-data' }">Experimental data</a></li><li><a href=#the-welford-algorithm :class="{'toc-h2':true, 'toc-highlight': currentHeading == '#the-welford-algorithm' }">The Welford algorithm</a></li><li><a href=#anomaly-detection-in-streams-with-extreme-value-theory :class="{'toc-h2':true, 'toc-highlight': currentHeading == '#anomaly-detection-in-streams-with-extreme-value-theory' }">Anomaly detection in streams with extreme value theory</a></li><li><a href=#spot :class="{'toc-h3':true, 'toc-highlight': currentHeading == '#spot' }">SPOT</a></li><li><a href=#half-space-trees :class="{'toc-h2':true, 'toc-highlight': currentHeading == '#half-space-trees' }">Half-Space Trees</a></li></ul></nav><h4>Related</h4><nav><ul><li class="header-post toc"><span class=backlink-count>1</span>
<a href=/machine-learning.html>Machine Learning</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Streaming anomaly detection</h1><div class=meta><div class=postdate>Updated <time datetime="2023-09-02 17:28:34 +0100 BST" itemprop=datePublished>2023-09-02</time>
<span class=commit-hash>(<a href=/log/index.html#d64c4a5>d64c4a5</a>)</span></div></div></header><div class=content itemprop=articleBody><p>Useful algorithms:</p><ul><li>Conformalised density and distance-based anomaly detection in time-series data<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li><a href=#the-welford-algorithm>elford algorithm</a></li><li><a href=#anomaly-detection-in-streams-with-extreme-value-theory>Anomaly detection in streams with extreme value theory</a></li><li>Robust random cut forest based anomaly detection on streams<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li><li>Time-series anomaly detection service at Microsoft<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></li><li><a href=#half-space-trees>Half-Space Trees</a></li></ul><h2 id=experimental-data x-intersect="currentHeading = '#experimental-data'">Experimental data</h2><p>Let&rsquo;s assume the following sequence of observations that we will use with a variety of algorithms.
The data is labelled with <code>label</code> with <code>0</code> for normal observations and <code>1</code> for anomalies.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>pandas</span> <span style=font-weight:700>as</span> <span style=color:#555>pd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=font-weight:700>=</span> pd<span style=font-weight:700>.</span>read_csv(<span style=color:#b84>&#34;../../data/streamad/uniDS.csv&#34;</span>)
</span></span></code></pre></div><p><img src=/Streaming%20anomaly%20detection_files/figure-gfm/cell-3-output-1.png alt loading=lazy></p><h2 id=the-welford-algorithm x-intersect="currentHeading = '#the-welford-algorithm'">The Welford algorithm</h2><p>The Welford&rsquo;s method is an online algorithm (idescribe single-pass) to calculate running variance and standard deviation. It is formulated from the difference between the squared difference sums of $N$ and $N-1$ observations.</p><p>A basic implementation of the Welford&rsquo;s method can be:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>math</span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Welford</span>(<span style=color:#999>object</span>):
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>k <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>M <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>S <span style=font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>update</span>(self,x):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> x <span style=font-weight:700>is</span> <span style=font-weight:700>None</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span>
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>k <span style=font-weight:700>+=</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>        newM <span style=font-weight:700>=</span> self<span style=font-weight:700>.</span>M <span style=font-weight:700>+</span> (x <span style=font-weight:700>-</span> self<span style=font-weight:700>.</span>M)<span style=font-weight:700>*</span><span style=color:#099>1.</span><span style=font-weight:700>/</span>self<span style=font-weight:700>.</span>k
</span></span><span style=display:flex><span>        newS <span style=font-weight:700>=</span> self<span style=font-weight:700>.</span>S <span style=font-weight:700>+</span> (x <span style=font-weight:700>-</span> self<span style=font-weight:700>.</span>M)<span style=font-weight:700>*</span>(x <span style=font-weight:700>-</span> newM)
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>M, self<span style=font-weight:700>.</span>S <span style=font-weight:700>=</span> newM, newS
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>    @property
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>mean</span>(self):
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> self<span style=font-weight:700>.</span>M
</span></span><span style=display:flex><span>    @property
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>meanfull</span>(self):
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> self<span style=font-weight:700>.</span>mean, self<span style=font-weight:700>.</span>std<span style=font-weight:700>/</span>math<span style=font-weight:700>.</span>sqrt(self<span style=font-weight:700>.</span>k)
</span></span><span style=display:flex><span>    @property
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>std</span>(self):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> self<span style=font-weight:700>.</span>k<span style=font-weight:700>==</span><span style=color:#099>1</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> math<span style=font-weight:700>.</span>sqrt(self<span style=font-weight:700>.</span>S<span style=font-weight:700>/</span>(self<span style=font-weight:700>.</span>k<span style=font-weight:700>-</span><span style=color:#099>1</span>))
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> <span style=color:#b84>&#34;&lt;Welford: </span><span style=color:#b84>{}</span><span style=color:#b84> +- </span><span style=color:#b84>{}</span><span style=color:#b84>&gt;&#34;</span><span style=font-weight:700>.</span>format(self<span style=font-weight:700>.</span>mean, self<span style=font-weight:700>.</span>std)
</span></span></code></pre></div><p>Applying Welford&rsquo;s algorothm to our data we have:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>welford <span style=font-weight:700>=</span> Welford()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>means <span style=font-weight:700>=</span> []
</span></span><span style=display:flex><span><span style=font-weight:700>for</span> value <span style=font-weight:700>in</span> df<span style=font-weight:700>.</span>value<span style=font-weight:700>.</span>to_list():
</span></span><span style=display:flex><span>    welford<span style=font-weight:700>.</span>update(value)
</span></span><span style=display:flex><span>    means<span style=font-weight:700>.</span>append(welford<span style=font-weight:700>.</span>mean)
</span></span></code></pre></div><p><img src=/Streaming%20anomaly%20detection_files/figure-gfm/cell-6-output-1.png alt loading=lazy></p><h2 id=anomaly-detection-in-streams-with-extreme-value-theory x-intersect="currentHeading = '#anomaly-detection-in-streams-with-extreme-value-theory'">Anomaly detection in streams with extreme value theory</h2><p>A more in-detail page is available at <a href>Streaming anomaly detection with Extreme Value Theory</a>.</p><h3 id=spot x-intersect="currentHeading = '#spot'">SPOT</h3><p>An example with <code>streamad</code>&rsquo;s <code>SPOT</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> detector.
This is available in the <code>streamad.model.SpotDetector</code> package.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>streamad.util</span> <span style=font-weight:700>import</span> StreamGenerator, UnivariateDS, plot
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>streamad.util.dataset</span> <span style=font-weight:700>import</span> CustomDS
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>streamad.model</span> <span style=font-weight:700>import</span> SpotDetector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ds <span style=font-weight:700>=</span> CustomDS(<span style=color:#b84>&#34;../../data/streamad/uniDS.csv&#34;</span>)
</span></span><span style=display:flex><span>stream <span style=font-weight:700>=</span> StreamGenerator(ds<span style=font-weight:700>.</span>data)
</span></span><span style=display:flex><span>model <span style=font-weight:700>=</span> SpotDetector()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>scores <span style=font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>for</span> x <span style=font-weight:700>in</span> stream<span style=font-weight:700>.</span>iter_item():
</span></span><span style=display:flex><span>    score <span style=font-weight:700>=</span> model<span style=font-weight:700>.</span>fit_score(x)
</span></span><span style=display:flex><span>    <span style=font-weight:700>if</span> score:
</span></span><span style=display:flex><span>        scores<span style=font-weight:700>.</span>append(score)
</span></span><span style=display:flex><span>    <span style=font-weight:700>else</span>:
</span></span><span style=display:flex><span>        scores<span style=font-weight:700>.</span>append(<span style=color:#099>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data, label, date, features <span style=font-weight:700>=</span> ds<span style=font-weight:700>.</span>data, ds<span style=font-weight:700>.</span>label, ds<span style=font-weight:700>.</span>date, ds<span style=font-weight:700>.</span>features
</span></span></code></pre></div><p><img src=/Streaming%20anomaly%20detection_files/figure-gfm/cell-8-output-1.png alt loading=lazy></p><h2 id=half-space-trees x-intersect="currentHeading = '#half-space-trees'">Half-Space Trees</h2><p>See <a href>Half-Space Trees</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://arxiv.org/abs/1608.04585>https://arxiv.org/abs/1608.04585</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=http://proceedings.mlr.press/v48/guha16.pdf>http://proceedings.mlr.press/v48/guha16.pdf</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://arxiv.org/abs/1906.03821>https://arxiv.org/abs/1906.03821</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://dl.acm.org/doi/10.1145/3097983.3098144>https://dl.acm.org/doi/10.1145/3097983.3098144</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/draw/>Drawings</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#experimental-data>Experimental data</a></li><li><a href=#the-welford-algorithm>The Welford algorithm</a></li><li><a href=#anomaly-detection-in-streams-with-extreme-value-theory>Anomaly detection in streams with extreme value theory</a><ul><li><a href=#spot>SPOT</a></li></ul></li><li><a href=#half-space-trees>Half-Space Trees</a></li></ul></nav></div><div id=share-footer style=display:none></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Rui Vieira</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/draw/>Drawings</a></li><li><a href=/map/>All pages</a></li><li><a href=/search.html>Search</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/css/fa.min.css><script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/mark.min.js></script>
<script src=/js/main.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>